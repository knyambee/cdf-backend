<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.flowable.org/processdef">

    <process id="skillsDevelopmentBursaryTask" name="Skills Development Bursary" isExecutable="true">
        <startEvent id="startEvent"/>

        <!-- Ward -->
        <sequenceFlow sourceRef="startEvent" targetRef="wardApproveTask"/>
        <userTask id="wardApproveTask" name="Review Skills Development Bursary Application"
                  flowable:assignee="${wardCommittee.id}"/>
        <sequenceFlow sourceRef="wardApproveTask" targetRef="wardDecision"/>

        <exclusiveGateway id="wardDecision"/>
        <sequenceFlow sourceRef="wardDecision" targetRef="wardApprovalNotification">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="wardDecision" targetRef="sendWardRejectionMail">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${!approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>

        <serviceTask id="wardApprovalNotification" name="Submit application to constituency committee for review"
                     flowable:class="com.knyambe.cdfbackend.workflow.ward.WardApproval"/>
        <sequenceFlow sourceRef="wardApprovalNotification" targetRef="constituencyApproveTask"/>
        <serviceTask id="sendWardRejectionMail" flowable:type="mail">
            <extensionElements>
                <flowable:field name="from" stringValue="knyambedev@gmail.com"/>
                <flowable:field name="to" expression="knyambe.social@gmail.com"/>
                <flowable:field name="subject" expression="Your application for Skills Development Bursary"/>
                <flowable:field name="html">
                    <flowable:expression>
                        <![CDATA[
                          <html>
                            <body>
                              Hello Applicant,<br/><br/>

                              Your application for skills development bursary has been declined by the ward committee.<br/><br/>

                              Kind regards,<br/>
                              Ward Committee.
                            </body>
                          </html>
                        ]]>
                    </flowable:expression>
                </flowable:field>
            </extensionElements>
        </serviceTask>
        <sequenceFlow sourceRef="sendWardRejectionMail" targetRef="wardRejection"/>
        <endEvent id="wardRejection"/>

        <!--   Constituency -->
        <userTask id="constituencyApproveTask" name="Review Skills Development Bursary Submission"
                  flowable:assignee="${constituencyCommittee.id}"/>
        <sequenceFlow sourceRef="constituencyApproveTask" targetRef="constituencyDecision"/>

        <exclusiveGateway id="constituencyDecision"/>
        <sequenceFlow sourceRef="constituencyDecision" targetRef="constituencyApprovalNotification">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="constituencyDecision" targetRef="sendConstituencyRejectionMail">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${!approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <serviceTask id="constituencyApprovalNotification" name="Submit application to Local government for review"
                     flowable:class="com.knyambe.cdfbackend.workflow.constituency.ConstituencyApproval"/>
        <sequenceFlow sourceRef="constituencyApprovalNotification" targetRef="LocalGovernmentApproveTask"/>
        <serviceTask id="sendConstituencyRejectionMail" flowable:type="mail">
            <extensionElements>
                <flowable:field name="from" stringValue="knyambedev@gmail.com"/>
                <flowable:field name="to" expression="knyambe.social@gmail.com"/>
                <flowable:field name="subject" expression="Your submission for Skills Development Bursary"/>
                <flowable:field name="html">
                    <flowable:expression>
                        <![CDATA[
                          <html>
                            <body>
                              Hello Ward Committee,<br/><br/>

                              Your submission for skills development bursary has been declined by the constituency development committee.<br/><br/>

                              Kind regards,<br/>
                              Constituency Development Committee.
                            </body>
                          </html>
                        ]]>
                    </flowable:expression>
                </flowable:field>
            </extensionElements>
        </serviceTask>
        <sequenceFlow sourceRef="sendConstituencyRejectionMail" targetRef="constituencyRejection"/>
        <endEvent id="constituencyRejection"/>

        <!--   Local government     -->
        <userTask id="LocalGovernmentApproveTask" name="Review Skills Development Bursary Submission"
                  flowable:assignee="${localGov.id}"/>
        <sequenceFlow sourceRef="LocalGovernmentApproveTask" targetRef="localGovernmentDecision"/>
        <exclusiveGateway id="localGovernmentDecision"/>
        <sequenceFlow sourceRef="localGovernmentDecision" targetRef="localGovernmentApprovalNotification">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="localGovernmentDecision" targetRef="sendLocalGovernmentRejectionMail">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${!approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <serviceTask id="localGovernmentApprovalNotification" name="Submit application to the Minister for review"
                     flowable:class="com.knyambe.cdfbackend.workflow.localgovernment.LocalGovernmentApproval"/>
        <sequenceFlow sourceRef="localGovernmentApprovalNotification" targetRef="ministerApproveTask"/>
        <serviceTask id="sendLocalGovernmentRejectionMail" flowable:type="mail">
            <extensionElements>
                <flowable:field name="from" stringValue="knyambedev@gmail.com"/>
                <flowable:field name="to" expression="knyambe.social@gmail.com"/>
                <flowable:field name="subject" expression="Your submission for Skills Development Bursary"/>
                <flowable:field name="html">
                    <flowable:expression>
                        <![CDATA[
                          <html>
                            <body>
                              Hello Constituency Development Committee,<br/><br/>

                              Your submission for skills development bursary has been declined by the local authority.<br/><br/>

                              Kind regards,<br/>
                              Local Government Authority.
                            </body>
                          </html>
                        ]]>
                    </flowable:expression>
                </flowable:field>
            </extensionElements>
        </serviceTask>
        <sequenceFlow sourceRef="sendLocalGovernmentRejectionMail" targetRef="localGovernmentRejection"/>
        <endEvent id="localGovernmentRejection"/>

        <!--   Minister     -->
        <userTask id="ministerApproveTask" name="Review Skills Development Bursary Submission"
                  flowable:assignee="${minister.id}"/>
        <sequenceFlow sourceRef="ministerApproveTask" targetRef="ministerDecision"/>
        <exclusiveGateway id="ministerDecision"/>
        <sequenceFlow sourceRef="ministerDecision" targetRef="ministerApprovalNotification">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="ministerDecision" targetRef="sendMinisterRejectionMail">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[
          ${!approved}
        ]]>
            </conditionExpression>
        </sequenceFlow>
        <serviceTask id="ministerApprovalNotification" name="Final approval - Award funding."
                     flowable:class="com.knyambe.cdfbackend.workflow.minister.MinisterApproval"/>
        <sequenceFlow sourceRef="ministerApprovalNotification" targetRef="ministerApproval"/>
        <serviceTask id="sendMinisterRejectionMail" flowable:type="mail">
            <extensionElements>
                <flowable:field name="from" stringValue="knyambedev@gmail.com"/>
                <flowable:field name="to" expression="knyambe.social@gmail.com"/>
                <flowable:field name="subject" expression="Your submission for Skills Development Bursary"/>
                <flowable:field name="html">
                    <flowable:expression>
                        <![CDATA[
                          <html>
                            <body>
                              Hello Local Government,<br/><br/>

                              Your submission for skills development bursary has been declined by the minister.<br/><br/>

                              Kind regards,<br/>
                              Minister.
                            </body>
                          </html>
                        ]]>
                    </flowable:expression>
                </flowable:field>
            </extensionElements>
        </serviceTask>
        <sequenceFlow sourceRef="sendMinisterRejectionMail" targetRef="ministerRejection"/>
        <endEvent id="ministerApproval"/>
        <endEvent id="ministerRejection"/>
    </process>
</definitions>